/**
 * @fileoverview Firestore Security Rules for the lending system prototype.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on user authentication.
 * It broadly allows public read access to most collections for demonstration purposes,
 * while restricting write access to authenticated users.
 *
 * Data Structure:
 * The Firestore database consists of top-level collections for partners, loans,
 * installments, payments, receipts, and reports.
 *
 * Key Security Decisions:
 * - Public read access is enabled for all collections to facilitate demonstration.
 * - All write operations require user authentication (isSignedIn()).
 * - No specific roles or ownership models are enforced beyond authentication.
 *
 * Denormalization for Authorization:
 *  Not applicable at this time, as authentication is the sole authorization factor.
 *
 * Structural Segregation:
 *  Not applicable at this time.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read partner information, but only authenticated users can create, update, or delete partner data.
     * @path /partners/{partnerId}
     * @allow (get, list): Public read access.
     * @allow (create, update, delete): Only authenticated users can write.
     * @deny  (create, update, delete): Unauthenticated users cannot write.
     * @principle Allows public read access while restricting write access to authenticated users.
     */
    match /partners/{partnerId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read loan information, but only authenticated users can create, update, or delete loan data.
     * @path /loans/{loanId}
     * @allow (get, list): Public read access.
     * @allow (create, update, delete): Only authenticated users can write.
     * @deny  (create, update, delete): Unauthenticated users cannot write.
     * @principle Allows public read access while restricting write access to authenticated users.
     */
    match /loans/{loanId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read installment information, but only authenticated users can create, update, or delete installment data.
     * @path /installments/{installmentId}
     * @allow (get, list): Public read access.
     * @allow (create, update, delete): Only authenticated users can write.
     * @deny  (create, update, delete): Unauthenticated users cannot write.
     * @principle Allows public read access while restricting write access to authenticated users.
     */
    match /installments/{installmentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read payment information, but only authenticated users can create, update, or delete payment data.
     * @path /payments/{paymentId}
     * @allow (get, list): Public read access.
     * @allow (create, update, delete): Only authenticated users can write.
     * @deny  (create, update, delete): Unauthenticated users cannot write.
     * @principle Allows public read access while restricting write access to authenticated users.
     */
    match /payments/{paymentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read receipt information, but only authenticated users can create, update, or delete receipt data.
     * @path /receipts/{receiptId}
     * @allow (get, list): Public read access.
     * @allow (create, update, delete): Only authenticated users can write.
     * @deny  (create, update, delete): Unauthenticated users cannot write.
     * @principle Allows public read access while restricting write access to authenticated users.
     */
    match /receipts/{receiptId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows anyone to read report information, but only authenticated users can create, update, or delete report data.
     * @path /reports/{reportId}
     * @allow (get, list): Public read access.
     * @allow (create, update, delete): Only authenticated users can write.
     * @deny  (create, update, delete): Unauthenticated users cannot write.
     * @principle Allows public read access while restricting write access to authenticated users.
     */
    match /reports/{reportId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}