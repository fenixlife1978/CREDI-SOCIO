/**
 * @fileoverview Firestore Security Rules for the lending system application.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on user authentication and
 * explicit authorization. It enforces data ownership where applicable and
 * provides controlled access to shared resources.
 *
 * Data Structure:
 * - /partners/{partnerId}: Stores partner information.
 * - /loans/{loanId}: Stores loan information.
 * - /installments/{installmentId}: Stores installment information.
 * - /payments/{paymentId}: Stores payment information.
 * - /receipts/{receiptId}: Stores receipt information.
 * - /reports/{reportId}: Stores generated financial reports.
 * - /settings/companyProfile: Stores the company profile information (single document).
 *
 * Key Security Decisions:
 * - Partners, Loans, Installments, Payments, Receipts and Reports can only be created, read, updated or deleted by authenticated users.
 * - The company profile information is accessible to any authenticated user.
 *
 * Denormalization for Authorization:
 *  - The security rules rely on authentication to grant access to the data. No data denormalization is required.
 *
 * Structural Segregation:
 * - All data is stored in top-level collections. There is no need to segregate private and public data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to company profile information for authenticated users.
     * @path /settings/companyProfile
     * @allow (get) Authenticated user can read the company profile.
     * @deny (create, update, delete) No one can create, update, or delete the company profile.
     * @principle Grants read access to authenticated users, but restricts write access.
     */
    match /settings/companyProfile {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to partner information.
     * @path /partners/{partnerId}
     * @allow (create) Authenticated user can create a partner.
     * @allow (get, list) Authenticated user can read partner information.
     * @allow (update, delete) Authenticated user can update or delete a partner.
     * @deny (create, update, delete) Requests without authentication are denied.
     * @principle Enforces access control based on authentication for all operations.
     */
    match /partners/{partnerId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages access to loan information.
     * @path /loans/{loanId}
     * @allow (create) Authenticated user can create a loan.
     * @allow (get, list) Authenticated user can read loan information.
     * @allow (update, delete) Authenticated user can update or delete a loan.
     * @deny (create, update, delete) Requests without authentication are denied.
     * @principle Enforces access control based on authentication for all operations.
     */
    match /loans/{loanId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages access to installment information.
     * @path /installments/{installmentId}
     * @allow (create) Authenticated user can create an installment.
     * @allow (get, list) Authenticated user can read installment information.
     * @allow (update, delete) Authenticated user can update or delete an installment.
     * @deny (create, update, delete) Requests without authentication are denied.
     * @principle Enforces access control based on authentication for all operations.
     */
    match /installments/{installmentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages access to payment information.
     * @path /payments/{paymentId}
     * @allow (create) Authenticated user can create a payment.
     * @allow (get, list) Authenticated user can read payment information.
     * @allow (update, delete) Authenticated user can update or delete a payment.
     * @deny (create, update, delete) Requests without authentication are denied.
     * @principle Enforces access control based on authentication for all operations.
     */
    match /payments/{paymentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages access to receipt information.
     * @path /receipts/{receiptId}
     * @allow (create) Authenticated user can create a receipt.
     * @allow (get, list) Authenticated user can read receipt information.
     * @allow (update, delete) Authenticated user can update or delete a receipt.
     * @deny (create, update, delete) Requests without authentication are denied.
     * @principle Enforces access control based on authentication for all operations.
     */
    match /receipts/{receiptId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages access to report information.
     * @path /reports/{reportId}
     * @allow (create) Authenticated user can create a report.
     * @allow (get, list) Authenticated user can read report information.
     * @allow (update, delete) Authenticated user can update or delete a report.
     * @deny (create, update, delete) Requests without authentication are denied.
     * @principle Enforces access control based on authentication for all operations.
     */
    match /reports/{reportId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }

  /**
   * @description Checks if the user is signed in.
   * @return {boolean} True if the user is signed in, false otherwise.
   */
  function isSignedIn() {
    return request.auth != null;
  }
}