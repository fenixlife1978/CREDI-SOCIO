/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict ownership model for most data, with public read access to some top-level collections.
 *
 * Data Structure:
 * - /partners/{partnerId}: Stores partner information.
 * - /loans/{loanId}: Stores loan information associated with a partner.
 * - /installments/{installmentId}: Stores installment information associated with a loan.
 * - /payments/{paymentId}: Stores payment information associated with a partner.
 * - /receipts/{receiptId}: Stores receipt information associated with a payment.
 * - /reports/{reportId}: Stores generated financial report data.
 * - /settings/companyProfile: Stores a single document with the company's profile information.
 *
 * Key Security Decisions:
 * - Partners, Loans, Installments, Payments, and Receipts are readable by all authenticated users, but only writable by authenticated users.
 * - Company Profile can be read by all, but cannot be created, updated, or deleted.
 *
 * */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows any authenticated user to list partners.
     * @path /partners/{partnerId}
     * @allow (list) Any authenticated user can list all partners.
     * @deny (list) Unauthenticated users cannot list partners.
     * @principle Public read access with authenticated write access.
     */
    match /partners/{partnerId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to list loans.
     * @path /loans/{loanId}
     * @allow (list) Any authenticated user can list all loans.
     * @deny (list) Unauthenticated users cannot list loans.
     * @principle Public read access with authenticated write access.
     */
    match /loans/{loanId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to list installments.
     * @path /installments/{installmentId}
     * @allow (list) Any authenticated user can list all installments.
     * @deny (list) Unauthenticated users cannot list installments.
     * @principle Public read access with authenticated write access.
     */
    match /installments/{installmentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to list payments.
     * @path /payments/{paymentId}
     * @allow (list) Any authenticated user can list all payments.
     * @deny (list) Unauthenticated users cannot list payments.
     * @principle Public read access with authenticated write access.
     */
    match /payments/{paymentId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to list receipts.
     * @path /receipts/{receiptId}
     * @allow (list) Any authenticated user can list all receipts.
     * @deny (list) Unauthenticated users cannot list receipts.
     * @principle Public read access with authenticated write access.
     */
    match /receipts/{receiptId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to list reports.
     * @path /reports/{reportId}
     * @allow (list) Any authenticated user can list all reports.
     * @deny (list) Unauthenticated users cannot list reports.
     * @principle Public read access with authenticated write access.
     */
    match /reports/{reportId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Allows any user to read the company profile, but prohibits writing.
     * @path /settings/companyProfile
     * @allow (get) Any user can read the company profile.
     * @deny (create) No one can create a new company profile (only one is allowed).
     * @principle Public read access with no write access.
     */
    match /settings/companyProfile {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}